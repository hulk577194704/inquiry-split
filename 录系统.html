<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关键词提取与分类工具</title>
    <!-- 引入 Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Element Plus JS -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- 引入 SheetJS 用于导出 Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #409EFF 0%, #67C23A 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tab-content {
            margin-top: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 25px 0 15px;
            color: #409EFF;
            padding-bottom: 8px;
            border-bottom: 2px solid #eef5fe;
        }
        
        .delimiter-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .upload-area {
            border: 2px dashed #c0ccda;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background-color: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #409EFF;
            background-color: #f0f7ff;
        }
        
        .result-area {
            margin-top: 25px;
        }
        
        .textarea-container {
            margin-top: 10px;
        }
        
        .category-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .category-column {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ebeef5;
            display: flex;
            flex-direction: column;
        }
        
        .category-header {
            background-color: #409EFF;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
        }
        
        .category-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .category-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .category-item {
            padding: 10px 12px;
            background-color: white;
            border-radius: 6px;
            border-left: 3px solid #409EFF;
            word-break: break-all;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .category-item.empty {
            text-align: center;
            color: #909399;
            font-style: italic;
            border-left-color: #dcdfe6;
        }
        
        .add-category {
            margin-top: 25px;
            text-align: center;
            padding: 15px;
            border: 1px dashed #dcdfe6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafafa;
        }
        
        .add-category:hover {
            border-color: #409EFF;
            background-color: #f0f7ff;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #409EFF;
        }
        
        .stat-label {
            font-size: 14px;
            color: #909399;
            margin-top: 5px;
        }
        
        .edit-modal {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .edit-textarea {
            margin-top: 10px;
        }
        
        .edit-hint {
            font-size: 13px;
            color: #909399;
            margin-top: 5px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #909399;
            font-size: 14px;
            border-top: 1px solid #ebeef5;
            margin-top: 30px;
        }
        
        .excel-export-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #e1f0ff;
        }
        
        .excel-export-options {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .excel-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ebeef5;
            border-radius: 6px;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .excel-table th, .excel-table td {
            border: 1px solid #dcdfe6;
            padding: 8px 12px;
            text-align: left;
            font-size: 13px;
        }
        
        .excel-table th {
            background-color: #f5f7fa;
            font-weight: 600;
            color: #303133;
        }
        
        .excel-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .uploaded-files-list {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .file-tag {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #dcdfe6;
        }
        
        .file-name {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-size {
            font-size: 12px;
            color: #909399;
        }
        
        .file-remove {
            cursor: pointer;
            color: #f56c6c;
        }
        
        .multi-file-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #e8f4ff;
            border-radius: 6px;
            border-left: 4px solid #409EFF;
        }
        
        .match-mode-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #ebeef5;
        }
        
        .match-mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .match-mode-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ebeef5;
        }
        
        .match-mode-name {
            min-width: 80px;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .delimiter-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .category-column {
                min-width: 100%;
            }
            
            .excel-export-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-name {
                max-width: 150px;
            }
            
            .match-mode-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .category-item-with-subkeys {
            border-left: 3px solid #E6A23C;
        }
        
        .category-item-main-key {
            font-weight: 600;
            color: #303133;
        }
        
        .category-item-sub-keys {
            font-size: 12px;
            color: #909399;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="container">
            <div class="header">
                <h1>关键词提取与分类工具</h1>
                <p>上传文本文件提取关键词，并按照自定义分类进行管理</p>
            </div>
            
            <div class="main-content">
                <el-tabs v-model="activeTab" type="border-card">
                    <el-tab-pane label="提取关键词" name="extract">
                        <div class="tab-content">
                            <h3 class="section-title">第一步：设置分隔符</h3>
                            <div class="delimiter-options">
                                <el-checkbox v-model="delimiters.comma">逗号 (,)</el-checkbox>
                                <el-checkbox v-model="delimiters.semicolon">分号 (;)</el-checkbox>
                                <el-checkbox v-model="delimiters.space">空格</el-checkbox>
                                <el-checkbox v-model="delimiters.tab">制表符</el-checkbox>
                                <el-checkbox v-model="delimiters.custom">自定义分隔符</el-checkbox>
                                <el-input 
                                    v-model="customDelimiter" 
                                    placeholder="请输入自定义分隔符，多个用|分隔"
                                    style="width: 250px;"
                                    :disabled="!delimiters.custom"
                                ></el-input>
                            </div>
                            
                            <h3 class="section-title">第二步：上传文本文件（支持多个文件）</h3>
                            <div class="upload-area">
                                <el-upload
                                    class="upload-demo"
                                    drag
                                    action="#"
                                    :auto-upload="false"
                                    :on-change="handleFileUpload"
                                    :on-remove="handleFileRemove"
                                    :multiple="true"
                                    :show-file-list="false"
                                    accept=".txt"
                                >
                                    <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                                    <div class="el-upload__text">
                                        将文件拖到此处，或<em>点击上传</em>
                                    </div>
                                    <template #tip>
                                        <div class="el-upload__tip">
                                            支持上传多个 .txt 文件，文件内容将按行合并处理
                                        </div>
                                    </template>
                                </el-upload>
                            </div>
                            
                            <div v-if="uploadedFiles.length > 0" class="uploaded-files-list">
                                <h4>已上传的文件 ({{ uploadedFiles.length }}个)</h4>
                                <div class="file-list">
                                    <div class="file-tag" v-for="(file, index) in uploadedFiles" :key="index">
                                        <el-icon><Document /></el-icon>
                                        <span class="file-name">{{ file.name }}</span>
                                        <span class="file-size">({{ formatFileSize(file.size) }})</span>
                                        <el-icon class="file-remove" @click="removeFile(index)"><Close /></el-icon>
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <el-button type="primary" size="small" @click="processAllFiles" :loading="processing">
                                        {{ processing ? '处理中...' : '处理所有文件' }}
                                    </el-button>
                                    <el-button size="small" @click="clearAllFiles">清空文件列表</el-button>
                                </div>
                            </div>
                            
                            <div v-if="fileContent" class="result-area">
                                <h3 class="section-title">第三步：处理结果</h3>
                                <div class="stats">
                                    <div class="stat-item">
                                        <div class="stat-value">{{ uploadedFiles.length }}</div>
                                        <div class="stat-label">文件数量</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{ originalLines }}</div>
                                        <div class="stat-label">总行数</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{ allKeywordsCount }}</div>
                                        <div class="stat-label">提取关键词数</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{ uniqueKeywordsCount }}</div>
                                        <div class="stat-label">去重后关键词数</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{ filteredKeywordsCount }}</div>
                                        <div class="stat-label">过滤后关键词数</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{ excludedKeywordsCount }}</div>
                                        <div class="stat-label">已排除关键词数</div>
                                    </div>
                                </div>
                                
                                <div v-if="excludedKeywords.length > 0" style="margin-top: 20px;">
                                    <h4 style="color: #f56c6c; margin-bottom: 10px;">已排除的关键词（已在分类管理中）</h4>
                                    <div style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #fde2e2; background-color: #fef0f0; border-radius: 6px;">
                                        <el-tag 
                                            v-for="(keyword, index) in excludedKeywords" 
                                            :key="index"
                                            style="margin: 3px;"
                                            type="info"
                                            size="small"
                                        >
                                            {{ keyword }}
                                        </el-tag>
                                    </div>
                                </div>
                                
                                <div class="textarea-container">
                                    <el-input
                                        v-model="processedText"
                                        type="textarea"
                                        :rows="15"
                                        placeholder="处理后的关键词将显示在这里"
                                    ></el-input>
                                </div>
                                
                                <div style="margin-top: 20px; text-align: center;">
                                    <el-button type="primary" @click="copyToClipboard" :disabled="!processedText">
                                        复制到剪贴板
                                    </el-button>
                                    <el-button type="success" @click="saveToFile" :disabled="!processedText">
                                        保存为文件
                                    </el-button>
                                    <el-button @click="clearResults">
                                        清除结果
                                    </el-button>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                    
                    <el-tab-pane label="分类关键字" name="categorize">
                        <div class="tab-content">
                            <h3 class="section-title">分类管理</h3>
                            <p style="margin-bottom: 15px; color: #606266;">
                                在这里创建和管理分类，每个分类项是逗号分隔的多个关键词字符串，第一个为主关键词，竖着展示。
                            </p>
                            
                            <div style="margin-bottom: 20px; text-align: center;">
                                <el-button type="success" @click="importFromJson">
                                    从JSON导入分类数据
                                </el-button>
                                <el-button type="primary" @click="exportCategories">
                                    导出分类数据为JSON
                                </el-button>
                                <el-button @click="clearAllCategories">
                                    清空所有分类
                                </el-button>
                            </div>
                            
                            <div class="category-container">
                                <div class="category-column" v-for="(category, index) in categories" :key="index">
                                    <div class="category-header">
                                        <div class="category-name">{{ category.name }}</div>
                                        <div class="category-actions">
                                            <el-button 
                                                type="primary" 
                                                size="small"
                                                @click="editCategory(index)"
                                            >
                                                编辑
                                            </el-button>
                                            <el-button 
                                                type="danger" 
                                                size="small"
                                                @click="removeCategory(index)"
                                                v-if="index >= defaultCategories.length"
                                            >
                                                删除
                                            </el-button>
                                        </div>
                                    </div>
                                    <div class="category-content">
                                        <div class="category-items">
                                            <div 
                                                class="category-item category-item-with-subkeys" 
                                                v-for="(keywordString, idx) in category.items" 
                                                :key="idx"
                                            >
                                                <div class="category-item-main-key">
                                                    {{ getMainKeyword(keywordString) }}
                                                </div>
                                                <div class="category-item-sub-keys" v-if="getSubKeywords(keywordString).length > 0">
                                                    同义词: {{ getSubKeywords(keywordString).join(', ') }}
                                                </div>
                                            </div>
                                            <div 
                                                class="category-item empty" 
                                                v-if="!category.items || category.items.length === 0"
                                            >
                                                暂无关键词
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="add-category" @click="addCategory">
                                <el-icon><Plus /></el-icon>
                                <span>添加新分类</span>
                            </div>
                            
                            <!-- Excel导出功能 -->
                            <div class="excel-export-section">
                                <h3 class="section-title">根据分类数据拆分导出为Excel（支持多个文件）</h3>
                                <p style="margin-bottom: 15px; color: #606266;">
                                    上传多个txt文件，将每个文件的每一行按分类数据拆分，并导出为Excel文件。
                                    匹配时对分类项中每个关键词进行匹配，取值时取第一个主关键词。
                                </p>
                                
                                <div class="upload-area">
                                    <el-upload
                                        class="upload-demo"
                                        drag
                                        action="#"
                                        :auto-upload="false"
                                        :on-change="handleExcelFileUpload"
                                        :on-remove="handleExcelFileRemove"
                                        :multiple="true"
                                        :show-file-list="false"
                                        accept=".txt"
                                    >
                                        <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                                        <div class="el-upload__text">
                                            将文件拖到此处，或<em>点击上传</em>
                                        </div>
                                        <template #tip>
                                            <div class="el-upload__tip">
                                                支持上传多个 .txt 文件，每个文件将分别处理并导出到独立的工作表
                                            </div>
                                        </template>
                                    </el-upload>
                                </div>
                                
                                <div v-if="excelFiles.length > 0" class="uploaded-files-list">
                                    <h4>已上传的文件 ({{ excelFiles.length }}个)</h4>
                                    <div class="file-list">
                                        <div class="file-tag" v-for="(file, index) in excelFiles" :key="index">
                                            <el-icon><Document /></el-icon>
                                            <span class="file-name">{{ file.name }}</span>
                                            <span class="file-size">({{ formatFileSize(file.size) }})</span>
                                            <el-icon class="file-remove" @click="removeExcelFile(index)"><Close /></el-icon>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <el-button size="small" @click="clearExcelFiles">清空文件列表</el-button>
                                    </div>
                                </div>
                                
                                <div class="multi-file-info" v-if="excelFiles.length > 1">
                                    <h4>多文件处理模式：每个文件一个独立工作表</h4>
                                    <p class="edit-hint">
                                        每个上传的txt文件将生成一个独立的工作表，工作表名称为文件名（不含扩展名）。
                                    </p>
                                </div>
                                
                                <!-- 匹配模式设置 -->
                                <div class="match-mode-section" v-if="categories.length > 0">
                                    <h4>匹配模式设置</h4>
                                    <p class="edit-hint" style="margin-bottom: 10px;">
                                        默认所有分类使用"只取最长匹配"模式，勾选的分类将使用"多匹配以逗号拼接"模式：
                                    </p>
                                    <div class="match-mode-grid">
                                        <div class="match-mode-item" v-for="(category, index) in categories" :key="index">
                                            <el-checkbox v-model="category.multipleMatch">
                                                多匹配以逗号拼接
                                            </el-checkbox>
                                            <span class="match-mode-name">{{ category.name }}</span>
                                        </div>
                                    </div>
                                    <p class="edit-hint" style="margin-top: 10px;">
                                        说明：<br>
                                        1. 默认所有分类使用"只取最长匹配"模式（勾选框未选中）<br>
                                        2. 勾选后表示该分类使用"多匹配以逗号拼接"模式<br>
                                        3. 匹配规则：先忽略大小写和前后空格，然后按以下顺序匹配：<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;a. 分割项完全等于分类关键词<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;b. 分割项包含"空格+分类关键词"<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;c. 分割项包含"分类关键词+空格"<br>
                                        4. 匹配时对分类项中每个关键词进行匹配，取值时取第一个主关键词<br>
                                        5. 未匹配到的分割项将放入"备注"列
                                    </p>
                                </div>
                                
                                <div class="excel-export-options">
                                    <div>
                                        <el-checkbox v-model="excelOptions.includeOriginal">包含原始行</el-checkbox>
                                        <el-tooltip content="是否在Excel中包含原始文本行" placement="top">
                                            <el-icon style="margin-left: 5px;"><InfoFilled /></el-icon>
                                        </el-tooltip>
                                    </div>
                                    <div>
                                        <el-checkbox v-model="excelOptions.includeSplitItems">包含分割项</el-checkbox>
                                        <el-tooltip content="是否在Excel中包含按分隔符分割后的所有项" placement="top">
                                            <el-icon style="margin-left: 5px;"><InfoFilled /></el-icon>
                                        </el-tooltip>
                                    </div>
                                    <div>
                                        <el-checkbox v-model="excelOptions.includeRemarks">包含备注列</el-checkbox>
                                        <el-tooltip content="是否在Excel中包含备注列（存放未匹配到的分割项）" placement="top">
                                            <el-icon style="margin-left: 5px;"><InfoFilled /></el-icon>
                                        </el-tooltip>
                                    </div>
                                    <el-button type="warning" @click="generateExcelData" :loading="excelLoading" :disabled="excelFiles.length === 0">
                                        {{ excelLoading ? '处理中...' : '生成Excel数据' }}
                                    </el-button>
                                    <el-button type="success" @click="exportToExcel" :disabled="!excelData.length">
                                        导出为Excel文件
                                    </el-button>
                                </div>
                                
                                <div v-if="excelData.length > 0" class="excel-preview">
                                    <h4 style="margin: 15px 0 10px 15px; color: #409EFF;">
                                        Excel预览 (前{{ Math.min(excelData.length, 10) }}行)
                                        <span v-if="excelSheets.length > 1"> - {{ currentSheetName }}</span>
                                    </h4>
                                    <table class="excel-table">
                                        <thead>
                                            <tr>
                                                <th v-if="excelOptions.includeOriginal">原始行</th>
                                                <th v-if="excelOptions.includeSplitItems">分割项</th>
                                                <th v-for="category in categories" :key="category.name">{{ category.name }}</th>
                                                <th v-if="excelOptions.includeRemarks">备注</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(row, index) in excelPreviewData" :key="index">
                                                <td v-if="excelOptions.includeOriginal">{{ row.original }}</td>
                                                <td v-if="excelOptions.includeSplitItems">{{ row.splitItems.join(', ') }}</td>
                                                <td v-for="category in categories" :key="category.name">{{ row[category.name] || '' }}</td>
                                                <td v-if="excelOptions.includeRemarks">{{ row.remarks || '' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="padding: 10px; text-align: center; color: #909399; font-size: 13px;">
                                        共 {{ currentSheetData.length }} 行数据，{{ categories.length }} 个分类
                                        <span v-if="excelSheets.length > 1">(当前工作表: {{ currentSheetName }})</span>
                                    </p>
                                    <div v-if="excelSheets.length > 1" style="text-align: center; margin-bottom: 10px;">
                                        <el-select v-model="currentSheetName" size="small" style="width: 200px;">
                                            <el-option v-for="sheet in excelSheets" :key="sheet.name" :label="sheet.name" :value="sheet.name"></el-option>
                                        </el-select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
            
            <div class="footer">
                <p>关键词提取与分类工具 &copy; 2023 | 使用 Vue 3 和 Element Plus 构建</p>
                <p style="margin-top: 5px;">提示：分类数据会自动保存在浏览器的本地存储中</p>
            </div>
        </div>
        
        <!-- 编辑分类对话框 -->
        <el-dialog
            v-model="editDialogVisible"
            :title="`编辑分类 - ${editingCategoryName}`"
            width="600px"
            :close-on-click-modal="false"
            class="edit-modal"
        >
            <div>
                <p class="edit-hint">每行输入一个逗号分隔的关键词串，第一个为主关键词：</p>
                <p class="edit-hint">格式示例：不锈钢,不锈铁,SS  (第一个"不锈钢"为主关键词，"不锈铁"和"SS"为同义词)</p>
                <el-input
                    v-model="editingCategoryContent"
                    type="textarea"
                    :rows="10"
                    class="edit-textarea"
                    placeholder="请输入关键词串，每行一个，格式：主关键词,同义词1,同义词2"
                ></el-input>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="editDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveEditingCategory">确定</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 导入JSON数据对话框 -->
        <el-dialog
            v-model="jsonImportDialogVisible"
            title="从JSON导入分类数据"
            width="700px"
            :close-on-click-modal="false"
        >
            <div>
                <p style="margin-bottom: 10px;">请粘贴JSON格式的分类数据：</p>
                <el-input
                    v-model="jsonImportData"
                    type="textarea"
                    :rows="12"
                    placeholder='{"名称": ["不锈钢,不锈铁,SS", "碳钢,CS"], "尺寸": ["10mm", "20mm"], "壁厚": []}'
                ></el-input>
                <div style="margin-top: 15px;">
                    <h4 style="margin-bottom: 10px;">JSON格式说明：</h4>
                    <div style="background-color: #f5f7fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 13px;">
                        {<br/>
                        &nbsp;&nbsp;"名称": ["不锈钢,不锈铁,SS", "碳钢,CS"],<br/>
                        &nbsp;&nbsp;"尺寸": ["10mm", "20mm,2cm"],<br/>
                        &nbsp;&nbsp;"壁厚": [],<br/>
                        &nbsp;&nbsp;"压力": ["高压,HP", "中压,MP", "低压,LP"],<br/>
                        &nbsp;&nbsp;"工艺": ["锻造,锻造件", "铸造,铸件"],<br/>
                        &nbsp;&nbsp;"材质": ["不锈钢,不锈铁,SS", "碳钢,CS"],<br/>
                        &nbsp;&nbsp;"标准": ["国标,GB", "美标,ASME"],<br/>
                        &nbsp;&nbsp;"连接面": ["平面,FF", "凸面,RF"]<br/>
                        }
                    </div>
                </div>
                <p class="edit-hint">导入的数据将合并到现有分类中，同名分类将被覆盖。所有关键词会自动去重和排序。</p>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="jsonImportDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="processJsonImport">导入</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        createApp({
            setup() {
                // 当前激活的标签页
                const activeTab = ref('extract');
                
                // 分隔符配置
                const delimiters = reactive({
                    comma: true,
                    semicolon: true,
                    space: false,
                    tab: false,
                    custom: false
                });
                
                const customDelimiter = ref('');
                
                // 第一个标签页文件相关数据
                const uploadedFiles = ref([]);
                const processing = ref(false);
                const fileContent = ref('');
                const originalLines = ref(0);
                const allKeywords = ref([]); // 所有提取的关键词
                const extractedKeywords = ref([]); // 过滤后的关键词
                const excludedKeywords = ref([]); // 被排除的关键词（已在分类管理中）
                const processedText = ref('');
                
                // 默认分类 - 添加multipleMatch属性，默认为false（只取最长匹配）
                const defaultCategories = [
                    { name: '名称', items: [], multipleMatch: false },
                    { name: '尺寸', items: [], multipleMatch: false },
                    { name: '壁厚', items: [], multipleMatch: false },
                    { name: '压力', items: [], multipleMatch: false },
                    { name: '工艺', items: [], multipleMatch: false },
                    { name: '材质', items: [], multipleMatch: false },
                    { name: '标准', items: [], multipleMatch: false },
                    { name: '连接面', items: [], multipleMatch: false }
                ];
                
                // 所有分类
                const categories = ref([...defaultCategories.map(cat => ({ 
                    ...cat, 
                    items: [...cat.items],
                    multipleMatch: cat.multipleMatch || false
                }))]);
                
                // 编辑对话框相关
                const editDialogVisible = ref(false);
                const editingCategoryIndex = ref(-1);
                const editingCategoryName = ref('');
                const editingCategoryContent = ref('');
                
                // JSON导入对话框相关
                const jsonImportDialogVisible = ref(false);
                const jsonImportData = ref('');
                
                // Excel导出相关
                const excelFiles = ref([]);
                const excelData = ref([]);
                const excelSheets = ref([]);
                const excelLoading = ref(false);
                const currentSheetName = ref('');
                const excelOptions = reactive({
                    includeOriginal: true,
                    includeSplitItems: true,
                    includeRemarks: true
                });
                
                // 计算属性
                const allKeywordsCount = computed(() => allKeywords.value.length);
                const uniqueKeywordsCount = computed(() => {
                    const set = new Set(extractedKeywords.value);
                    return set.size;
                });
                const filteredKeywordsCount = computed(() => extractedKeywords.value.length);
                const excludedKeywordsCount = computed(() => excludedKeywords.value.length);
                
                // 计算属性：当前工作表数据
                const currentSheetData = computed(() => {
                    if (excelSheets.value.length > 0) {
                        const sheet = excelSheets.value.find(s => s.name === currentSheetName.value);
                        return sheet ? sheet.data : [];
                    }
                    return excelData.value;
                });
                
                // 计算属性：Excel预览数据（前10行）
                const excelPreviewData = computed(() => {
                    return currentSheetData.value.slice(0, 10);
                });
                
                // 构建分隔符正则表达式
                const buildDelimiterRegex = () => {
                    let delimiterPattern = '';
                    
                    if (delimiters.comma) delimiterPattern += ',';
                    if (delimiters.semicolon) delimiterPattern += ';';
                    if (delimiters.space) delimiterPattern += ' ';
                    if (delimiters.tab) delimiterPattern += '\\t';
                    
                    if (delimiters.custom && customDelimiter.value) {
                        if (delimiterPattern) delimiterPattern += '|';
                        delimiterPattern += customDelimiter.value;
                    }
                    
                    return new RegExp(`[${delimiterPattern}]+`, 'g');
                };
                
                // 格式化文件大小
                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                // 获取主关键词（逗号分隔字符串的第一个）
                const getMainKeyword = (keywordString) => {
                    if (!keywordString) return '';
                    const parts = keywordString.split(',').map(part => part.trim());
                    return parts[0] || '';
                };
                
                // 获取同义词（逗号分隔字符串的第二个及以后的部分）
                const getSubKeywords = (keywordString) => {
                    if (!keywordString) return [];
                    const parts = keywordString.split(',').map(part => part.trim());
                    return parts.slice(1).filter(part => part.length > 0);
                };
                
                // 从逗号分隔字符串中提取所有关键词
                const getAllKeywordsFromString = (keywordString) => {
                    if (!keywordString) return [];
                    return keywordString.split(',').map(part => part.trim()).filter(part => part.length > 0);
                };
                
                // 关键词去重和排序函数（针对逗号分隔的字符串）
                const deduplicateAndSortKeywordStrings = (keywordStrings) => {
                    if (!Array.isArray(keywordStrings)) return [];
                    
                    // 去重：根据主关键词去重
                    const keywordMap = new Map();
                    keywordStrings.forEach(str => {
                        const mainKeyword = getMainKeyword(str);
                        if (mainKeyword && !keywordMap.has(mainKeyword)) {
                            keywordMap.set(mainKeyword, str);
                        }
                    });
                    
                    // 转换为数组并按主关键词排序
                    return Array.from(keywordMap.values())
                        .sort((a, b) => getMainKeyword(a).localeCompare(getMainKeyword(b)));
                };
                
                // 获取所有分类中的所有关键词（包括主关键词和同义词）
                const getAllCategoryKeywords = () => {
                    const keywordSet = new Set();
                    categories.value.forEach(category => {
                        category.items.forEach(keywordString => {
                            const allKeywords = getAllKeywordsFromString(keywordString);
                            allKeywords.forEach(keyword => {
                                keywordSet.add(keyword.trim());
                            });
                        });
                    });
                    return [...keywordSet].sort((a, b) => b.length - a.length);
                };
                
                // 过滤关键词：排除已在分类管理中的关键词
                const filterKeywords = (keywords) => {
                    const categoryKeywords = getAllCategoryKeywords();
                    const categoryKeywordSetLow = new Set();
                    categoryKeywords.forEach(categoryKeyword => categoryKeywordSetLow.add(categoryKeyword.toLowerCase()));
                    
                    const filtered = [];
                    const excluded = [];
                    
                    keywords.forEach(keyword => {
                        // 标准化关键词：去除前后空格，转为小写
                        const normalized = keyword.trim().toLowerCase();
                        if (!normalized || categoryKeywordSetLow.has(normalized)) {
                            excluded.push(keyword);
                            return;
                        }
                        
                        // 检查是否包含分类关键词
                        let shouldExclude = false;
                        for (const categoryKeyword of categoryKeywords) {
                            if (matchesKeyword(keyword, categoryKeyword)) {
                                excluded.push(categoryKeyword);
                                shouldExclude = true;
                                // 移除匹配到的部分
                                keyword = keyword.split(categoryKeyword).join('').trim();
                            }
                        }
                        
                        if (shouldExclude && keyword.length === 0) {
                            // 如果整个关键词都被排除了，不再添加到过滤后列表
                            return;
                        }
                        
                        if (keyword.trim().length > 0) {
                            filtered.push(keyword.trim());
                        }
                    });
                    
                    return { filtered, excluded };
                };
                
                // 匹配函数：按照指定规则匹配
                const matchesKeyword = (splitItem, keyword) => {
                    if (!splitItem || !keyword) return false;
                    
                    const normalizedSplitItem = splitItem.trim().toLowerCase();
                    const normalizedKeyword = keyword.trim().toLowerCase();
                    
                    // 规则1：分割项完全等于分类关键词
                    if (normalizedSplitItem === normalizedKeyword) {
                        return true;
                    }
                    // 规则2：分类关键词包含"空格"，分割项包含分类关键词
                    if (normalizedKeyword.includes(' ') && normalizedSplitItem.includes(normalizedKeyword)) {
                        return true;
                    }
                    
                    // 规则3：分割项包含"空格+分类关键词"
                    if (normalizedSplitItem.includes(' ' + normalizedKeyword)) {
                        return true;
                    }
                    
                    // 规则4：分割项包含"分类关键词+空格"
                    if (normalizedSplitItem.includes(normalizedKeyword + ' ')) {
                        return true;
                    }
                    
                    return false;
                };
                
                // 匹配分类项：检查分割项是否匹配分类项中的任何关键词
                const matchesCategoryItem = (splitItem, categoryItem) => {
                    if (!splitItem || !categoryItem) return false;
                    
                    // 从逗号分隔的字符串中提取所有关键词
                    const allKeywords = getAllKeywordsFromString(categoryItem);
                    
                    // 检查是否匹配任何关键词
                    for (const keyword of allKeywords) {
                        if (matchesKeyword(splitItem, keyword)) {
                            return true;
                        }
                    }
                    
                    return false;
                };
                
                // 第一个标签页：上传文件
                const handleFileUpload = (file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedFiles.value.push({
                            name: file.name,
                            size: file.size,
                            content: e.target.result
                        });
                    };
                    reader.readAsText(file.raw);
                };
                
                // 第一个标签页：移除文件
                const handleFileRemove = (file) => {
                    // Element Plus上传组件的移除事件
                    // 我们这里不使用这个，因为我们自己管理文件列表
                };
                
                // 第一个标签页：手动移除文件
                const removeFile = (index) => {
                    uploadedFiles.value.splice(index, 1);
                };
                
                // 第一个标签页：清空所有文件
                const clearAllFiles = () => {
                    uploadedFiles.value = [];
                    fileContent.value = '';
                    allKeywords.value = [];
                    extractedKeywords.value = [];
                    excludedKeywords.value = [];
                    processedText.value = '';
                    originalLines.value = 0;
                };
                
                // 第一个标签页：处理所有文件
                const processAllFiles = () => {
                    if (uploadedFiles.value.length === 0) {
                        ElMessage.warning('请先上传文件');
                        return;
                    }
                    
                    processing.value = true;
                    
                    try {
                        // 合并所有文件内容
                        const allContent = uploadedFiles.value.map(file => file.content).join('\n');
                        fileContent.value = allContent;
                        
                        // 处理文件内容
                        processFileContent();
                        
                        ElMessage.success(`成功处理 ${uploadedFiles.value.length} 个文件`);
                    } catch (error) {
                        console.error('处理文件失败:', error);
                        ElMessage.error('处理文件时出错');
                    } finally {
                        processing.value = false;
                    }
                };
                
                // 处理文件内容
                const processFileContent = () => {
                    if (!fileContent.value) return;
                    
                    // 按行分割
                    const lines = fileContent.value.split(/\r?\n/);
                    originalLines.value = lines.length;
                    
                    // 分割关键词
                    const regex = buildDelimiterRegex();
                    let keywords = [];
                    
                    lines.forEach(line => {
                        if (line.trim()) {
                            const lineKeywords = line.split(regex).map(k => k.trim()).filter(k => k);
                            keywords.push(...lineKeywords);
                        }
                    });
                    
                    // 保存所有关键词
                    allKeywords.value = keywords;
                    
                    // 过滤关键词：排除已在分类管理中的关键词
                    const { filtered, excluded } = filterKeywords(keywords);
                    
                    // 去重并排序
                    const uniqueKeywords = [...new Set(filtered)].sort();
                    extractedKeywords.value = uniqueKeywords;
                    excludedKeywords.value = [...new Set(excluded)].sort();
                    
                    // 生成处理后的文本
                    processedText.value = uniqueKeywords.join('\n');
                };
                
                // 监听分隔符变化
                watch([delimiters, customDelimiter], () => {
                    if (fileContent.value) {
                        processFileContent();
                    }
                }, { deep: true });
                
                // 监听分类变化，重新处理文件（如果需要）
                watch(categories, () => {
                    if (fileContent.value && allKeywords.value.length > 0) {
                        // 重新过滤关键词
                        const { filtered, excluded } = filterKeywords(allKeywords.value);
                        
                        // 去重并排序
                        const uniqueKeywords = [...new Set(filtered)].sort();
                        extractedKeywords.value = uniqueKeywords;
                        excludedKeywords.value = [...new Set(excluded)].sort();
                        
                        // 生成处理后的文本
                        processedText.value = uniqueKeywords.join('\n');
                    }
                }, { deep: true });
                
                // 复制到剪贴板
                const copyToClipboard = () => {
                    navigator.clipboard.writeText(processedText.value).then(() => {
                        ElMessage.success('已复制到剪贴板');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        ElMessage.error('复制失败');
                    });
                };
                
                // 保存为文件
                const saveToFile = () => {
                    const blob = new Blob([processedText.value], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '提取的关键词.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    ElMessage.success('文件已保存');
                };
                
                // 清除结果
                const clearResults = () => {
                    fileContent.value = '';
                    allKeywords.value = [];
                    extractedKeywords.value = [];
                    excludedKeywords.value = [];
                    processedText.value = '';
                    originalLines.value = 0;
                };
                
                // 第二个标签页：上传Excel处理文件
                const handleExcelFileUpload = (file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        excelFiles.value.push({
                            name: file.name,
                            size: file.size,
                            content: e.target.result
                        });
                    };
                    reader.readAsText(file.raw);
                };
                
                // 第二个标签页：Excel文件移除事件
                const handleExcelFileRemove = (file) => {
                    // Element Plus上传组件的移除事件
                };
                
                // 第二个标签页：移除Excel文件
                const removeExcelFile = (index) => {
                    excelFiles.value.splice(index, 1);
                };
                
                // 第二个标签页：清空Excel文件
                const clearExcelFiles = () => {
                    excelFiles.value = [];
                    excelData.value = [];
                    excelSheets.value = [];
                };
                
                // 编辑分类
                const editCategory = (index) => {
                    editingCategoryIndex.value = index;
                    editingCategoryName.value = categories.value[index].name;
                    // 将数组转换为按回车分割的字符串
                    editingCategoryContent.value = categories.value[index].items.join('\n');
                    editDialogVisible.value = true;
                };
                
                // 保存编辑的分类
                const saveEditingCategory = () => {
                    if (editingCategoryIndex.value === -1) return;
                    
                    // 将字符串按回车分割，并过滤空行
                    const items = editingCategoryContent.value
                        .split('\n')
                        .map(item => item.trim())
                        .filter(item => item);
                    
                    // 去重并排序（根据主关键词去重和排序）
                    const deduplicatedItems = deduplicateAndSortKeywordStrings(items);
                    
                    categories.value[editingCategoryIndex.value].items = deduplicatedItems;
                    saveCategoriesToStorage();
                    editDialogVisible.value = false;
                    editingCategoryIndex.value = -1;
                    editingCategoryContent.value = '';
                    
                    ElMessage.success('分类已保存（已自动根据主关键词去重和排序）');
                };
                
                // 添加新分类
                const addCategory = () => {
                    ElMessageBox.prompt('请输入新分类名称', '添加分类', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPlaceholder: '例如：颜色、品牌、型号等'
                    }).then(({ value }) => {
                        if (value && value.trim()) {
                            categories.value.push({
                                name: value.trim(),
                                items: [],
                                multipleMatch: false // 默认只取最长匹配
                            });
                            saveCategoriesToStorage();
                            ElMessage.success(`分类 "${value}" 已添加`);
                        }
                    }).catch(() => {
                        // 用户取消
                    });
                };
                
                // 删除分类
                const removeCategory = (index) => {
                    if (index < defaultCategories.length) return;
                    
                    ElMessageBox.confirm(
                        `确定要删除分类 "${categories.value[index].name}" 吗？`,
                        '删除分类',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                        }
                    ).then(() => {
                        const removed = categories.value.splice(index, 1);
                        saveCategoriesToStorage();
                        ElMessage.success(`分类 "${removed[0].name}" 已删除`);
                    }).catch(() => {
                        // 用户取消
                    });
                };
                
                // 清空所有分类
                const clearAllCategories = () => {
                    ElMessageBox.confirm(
                        '确定要清空所有分类的内容吗？此操作不可撤销。',
                        '清空分类',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                        }
                    ).then(() => {
                        categories.value.forEach(cat => {
                            cat.items = [];
                        });
                        saveCategoriesToStorage();
                        ElMessage.success('所有分类已清空');
                    }).catch(() => {
                        // 用户取消
                    });
                };
                
                // 从JSON导入分类数据
                const importFromJson = () => {
                    jsonImportData.value = '';
                    jsonImportDialogVisible.value = true;
                };
                
                // 处理JSON导入
                const processJsonImport = () => {
                    try {
                        if (!jsonImportData.value.trim()) {
                            ElMessage.error('请输入JSON数据');
                            return;
                        }
                        
                        const jsonData = JSON.parse(jsonImportData.value);
                        
                        // 验证JSON格式
                        if (typeof jsonData !== 'object' || jsonData === null) {
                            ElMessage.error('JSON数据格式不正确，应为对象格式');
                            return;
                        }
                        
                        // 遍历JSON数据
                        let importCount = 0;
                        Object.entries(jsonData).forEach(([categoryName, items]) => {
                            // 验证items是否为数组
                            if (!Array.isArray(items)) {
                                console.warn(`分类 "${categoryName}" 的值不是数组，跳过`);
                                return;
                            }
                            
                            // 去重和排序（根据主关键词）
                            const deduplicatedItems = deduplicateAndSortKeywordStrings(items);
                            
                            // 查找是否已存在该分类
                            const existingIndex = categories.value.findIndex(cat => cat.name === categoryName);
                            
                            if (existingIndex !== -1) {
                                // 更新现有分类
                                categories.value[existingIndex].items = deduplicatedItems;
                            } else {
                                // 添加新分类
                                categories.value.push({
                                    name: categoryName,
                                    items: deduplicatedItems,
                                    multipleMatch: false // 默认只取最长匹配
                                });
                            }
                            
                            importCount++;
                        });
                        
                        saveCategoriesToStorage();
                        jsonImportDialogVisible.value = false;
                        jsonImportData.value = '';
                        
                        if (importCount > 0) {
                            ElMessage.success(`成功导入 ${importCount} 个分类的数据（已自动根据主关键词去重和排序）`);
                        } else {
                            ElMessage.warning('未导入任何分类数据');
                        }
                    } catch (error) {
                        console.error('JSON导入失败:', error);
                        ElMessage.error(`导入失败：${error.message}`);
                    }
                };
                
                // 导出分类数据为JSON
                const exportCategories = () => {
                    const data = {};
                    categories.value.forEach(cat => {
                        if (cat.items.length > 0) {
                            data[cat.name] = cat.items;
                        }
                    });
                    
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '分类数据.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    ElMessage.success('分类数据已导出为JSON文件');
                };
                
                // 生成Excel数据
                const generateExcelData = () => {
                    if (excelFiles.value.length === 0) {
                        ElMessage.warning('请先上传txt文件');
                        return;
                    }
                    
                    if (categories.value.length === 0) {
                        ElMessage.warning('请先添加分类数据');
                        return;
                    }
                    
                    excelLoading.value = true;
                    
                    try {
                        const regex = buildDelimiterRegex();
                        const sheets = [];
                        let totalRows = 0;
                        
                        // 每个文件一个工作表模式
                        excelFiles.value.forEach(file => {
                            const lines = file.content.split(/\r?\n/);
                            const fileData = [];
                            
                            lines.forEach((line, lineIndex) => {
                                if (!line.trim()) {
                                    fileData.push({
                                        original: line,
                                        splitItems: [],
                                        remarks: [] 
                                    });
                                    return;
                                }
                                const rowData = {
                                    original: line,
                                    splitItems: line.split(regex).map(item => item.trim()).filter(item => item),
                                    remarks: [] // 用于存放未匹配到的分割项
                                };
                                
                                // 为每个分类初始化空值
                                categories.value.forEach(category => {
                                    rowData[category.name] = [];
                                });
                                
                                // 遍历分割项
                                rowData.splitItems.forEach(splitItem => {
                                    let matched = false;
                                    
                                    // 先处理每个分类
                                    categories.value.forEach(category => {
                                        // 找出该分类中所有匹配的分类项（每个分类项是逗号分隔的字符串）
                                        const matchedCategoryItems = category.items.filter(categoryItem => 
                                            matchesCategoryItem(splitItem, categoryItem)
                                        );
                                        
                                        // 按长度 降序排序（根据主关键词长度）
                                        matchedCategoryItems.sort((a, b) => {
                                            const aMain = getMainKeyword(a);
                                            const bMain = getMainKeyword(b);
                                            return bMain.length - aMain.length;
                                        });
                                        
                                        if (matchedCategoryItems.length > 0) {
                                            matched = true;
                                            // 只取第一个匹配的分类项的主关键词
                                            const mainKeyword = getMainKeyword(matchedCategoryItems[0]);
                                            rowData[category.name].push(mainKeyword);
                                        }
                                    });
                                    
                                    // 如果这个分割项没有匹配到任何分类，则添加到备注
                                    if (!matched) {
                                        rowData.remarks.push(splitItem);
                                    }
                                });
                                
                                // 根据匹配模式处理每个分类的结果
                                categories.value.forEach(category => {
                                    const matches = rowData[category.name];
                                    if (matches.length === 0) {
                                        rowData[category.name] = '';
                                    } else if (category.multipleMatch) {
                                        // 多匹配以逗号拼接
                                        // 去重并按原始顺序保留
                                        const uniqueMatches = [];
                                        matches.forEach(match => {
                                            if (!uniqueMatches.includes(match)) {
                                                uniqueMatches.push(match);
                                            }
                                        });
                                        rowData[category.name] = uniqueMatches.join(', ');
                                    } else {
                                        // 只取最长匹配（默认）
                                        let longestMatch = '';
                                        matches.forEach(match => {
                                            if (match.length > longestMatch.length) {
                                                longestMatch = match;
                                            }
                                        });
                                        rowData[category.name] = longestMatch;
                                    }
                                });
                                
                                // 处理备注
                                if (rowData.remarks.length > 0) {
                                    rowData.remarks = rowData.remarks.join(', ');
                                } else {
                                    rowData.remarks = '';
                                }
                                
                                fileData.push(rowData);
                            });
                            
                            // 工作表名不能超过31个字符，不能包含特殊字符
                            let sheetName = file.name.replace('.txt', '').substring(0, 31);
                            sheetName = sheetName.replace(/[\\/:*?"<>|]/g, '_'); // 替换非法字符
                            
                            sheets.push({
                                name: sheetName,
                                data: fileData
                            });
                            
                            totalRows += fileData.length;
                        });
                        
                        excelSheets.value = sheets;
                        if (sheets.length > 0) {
                            currentSheetName.value = sheets[0].name;
                            excelData.value = sheets[0].data;
                        }
                        
                        ElMessage.success(`成功处理 ${excelFiles.value.length} 个文件，共 ${totalRows} 行数据，生成 ${sheets.length} 个工作表`);
                    } catch (error) {
                        console.error('生成Excel数据失败:', error);
                        ElMessage.error('处理数据时出错，请检查格式');
                    } finally {
                        excelLoading.value = false;
                    }
                };
                
                // 监听当前工作表变化
                watch(currentSheetName, (newVal) => {
                    if (excelSheets.value.length > 0) {
                        const sheet = excelSheets.value.find(s => s.name === newVal);
                        if (sheet) {
                            excelData.value = sheet.data;
                        }
                    }
                });
                
                // 导出为Excel文件
                const exportToExcel = () => {
                    if (excelSheets.value.length === 0) {
                        ElMessage.warning('没有可导出的数据');
                        return;
                    }
                    
                    try {
                        // 创建工作簿
                        const wb = XLSX.utils.book_new();
                        
                        // 为每个工作表添加数据
                        excelSheets.value.forEach(sheet => {
                            // 准备工作表数据
                            const wsData = [];
                            
                            // 表头
                            const headers = [];
                            if (excelOptions.includeOriginal) headers.push('原始行');
                            if (excelOptions.includeSplitItems) headers.push('分割项');
                            categories.value.forEach(category => headers.push(category.name));
                            if (excelOptions.includeRemarks) headers.push('备注');
                            wsData.push(headers);
                            
                            // 数据行
                            sheet.data.forEach(row => {
                                const rowData = [];
                                if (excelOptions.includeOriginal) rowData.push(row.original);
                                if (excelOptions.includeSplitItems) rowData.push(row.splitItems.join(', '));
                                categories.value.forEach(category => rowData.push(row[category.name] || ''));
                                if (excelOptions.includeRemarks) rowData.push(row.remarks || '');
                                wsData.push(rowData);
                            });
                            
                            // 创建工作表
                            const ws = XLSX.utils.aoa_to_sheet(wsData);
                            
                            // 设置列宽
                            const wscols = [];
                            headers.forEach(() => wscols.push({ wch: 20 })); // 每列宽度20字符
                            ws['!cols'] = wscols;
                            
                            // 添加到工作簿
                            XLSX.utils.book_append_sheet(wb, ws, sheet.name);
                        });
                        
                        // 导出文件
                        const fileName = `分类拆分数据_多文件_${new Date().toISOString().slice(0, 10)}.xlsx`;
                        XLSX.writeFile(wb, fileName);
                        
                        ElMessage.success(`Excel文件已导出: ${fileName}，包含 ${excelSheets.value.length} 个工作表`);
                    } catch (error) {
                        console.error('导出Excel失败:', error);
                        ElMessage.error('导出Excel文件时出错');
                    }
                };
                
                // 保存分类到本地存储（包括匹配模式）
                const saveCategoriesToStorage = () => {
                    const data = categories.value.map(cat => ({
                        name: cat.name,
                        items: cat.items,
                        multipleMatch: cat.multipleMatch || false
                    }));
                    
                    localStorage.setItem('keywordCategories', JSON.stringify(data));
                };
                
                // 从本地存储加载分类（包括匹配模式）
                const loadCategoriesFromStorage = () => {
                    try {
                        const saved = localStorage.getItem('keywordCategories');
                        if (saved) {
                            const savedCategories = JSON.parse(saved);
                            
                            // 先清空所有分类
                            categories.value.forEach(cat => {
                                cat.items = [];
                            });
                            
                            // 更新分类数据
                            savedCategories.forEach(savedCat => {
                                const existingIndex = categories.value.findIndex(cat => cat.name === savedCat.name);
                                if (existingIndex !== -1) {
                                    // 更新现有分类，并根据主关键词去重排序
                                    categories.value[existingIndex].items = deduplicateAndSortKeywordStrings(
                                        Array.isArray(savedCat.items) ? savedCat.items : []
                                    );
                                    // 更新匹配模式
                                    if (savedCat.multipleMatch !== undefined) {
                                        categories.value[existingIndex].multipleMatch = savedCat.multipleMatch;
                                    }
                                } else {
                                    // 添加新分类，并根据主关键词去重排序
                                    categories.value.push({
                                        name: savedCat.name,
                                        items: deduplicateAndSortKeywordStrings(
                                            Array.isArray(savedCat.items) ? savedCat.items : []
                                        ),
                                        multipleMatch: savedCat.multipleMatch || false
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('加载分类数据失败:', e);
                    }
                };
                
                // 页面加载时从本地存储加载分类数据
                onMounted(() => {
                    loadCategoriesFromStorage();
                });
                
                return {
                    activeTab,
                    delimiters,
                    customDelimiter,
                    uploadedFiles,
                    processing,
                    fileContent,
                    originalLines,
                    allKeywords,
                    extractedKeywords,
                    excludedKeywords,
                    processedText,
                    categories,
                    defaultCategories,
                    allKeywordsCount,
                    uniqueKeywordsCount,
                    filteredKeywordsCount,
                    excludedKeywordsCount,
                    excelFiles,
                    excelData,
                    excelSheets,
                    excelLoading,
                    currentSheetName,
                    excelOptions,
                    currentSheetData,
                    excelPreviewData,
                    editDialogVisible,
                    editingCategoryName,
                    editingCategoryContent,
                    jsonImportDialogVisible,
                    jsonImportData,
                    formatFileSize,
                    getMainKeyword,
                    getSubKeywords,
                    handleFileUpload,
                    handleFileRemove,
                    removeFile,
                    clearAllFiles,
                    processAllFiles,
                    copyToClipboard,
                    saveToFile,
                    clearResults,
                    handleExcelFileUpload,
                    handleExcelFileRemove,
                    removeExcelFile,
                    clearExcelFiles,
                    editCategory,
                    saveEditingCategory,
                    addCategory,
                    removeCategory,
                    clearAllCategories,
                    importFromJson,
                    processJsonImport,
                    exportCategories,
                    generateExcelData,
                    exportToExcel
                };
            }
        })
        .use(ElementPlus)
        .mount('#app');
    </script>
</body>
</html>